#!/bin/sh

set -ex

BUILD_DIR=$1
APT_DIR=$BUILD_DIR/.apt
VENDOR_DIR="$BUILD_DIR/vendor"
mkdir -p $VENDOR_DIR
INSTALL_DIR="$VENDOR_DIR/libreoffice"
mkdir -p $INSTALL_DIR
CACHE_DIR=$2 # the contents of CACHE_DIR are persisted between builds

# LibreOffice 4.4.5
if [ -f $BUILD_DIR/LibreOfficeAppImage ] ; then
    DOWNLOAD=$(grep http $BUILD_DIR/LibreOfficeAppImage | head -n 1)
else
    DOWNLOAD="https://downloadarchive.documentfoundation.org/libreoffice/old/4.4.5.2/LibreOffice_4.4.5.2_Linux_x86-64_deb.tar.gz"
fi
VERSION="4.4.5.2" # Explicit version for clarity
FILE_NAME="LibreOffice_${VERSION}_Linux_x86-64_deb.tar.gz"

mkdir -p $CACHE_DIR
if ! [ -e $CACHE_DIR/$FILE_NAME ]; then
  echo "-----> downloading LibreOffice 4.4.5"
  curl -L $DOWNLOAD > $CACHE_DIR/$FILE_NAME

  echo "-----> extracting LibreOffice from archive"
  cd $CACHE_DIR
  tar -xzf $FILE_NAME
  mv LibreOffice_4.4.5.2/ $INSTALL_DIR
else
  echo "file already exists $CACHE_DIR/$FILE_NAME"
fi

# Update profile to include LibreOffice in PATH
PROFILE_PATH="$BUILD_DIR/.profile.d/libreoffice.sh"
RUNTIME_INSTALL_PATH="\$HOME/vendor/libreoffice"
mkdir -p $(dirname $PROFILE_PATH)
INSTALLED_VERSION=$(ls $INSTALL_DIR/opt)
echo "export PATH=$RUNTIME_INSTALL_PATH/opt/$INSTALLED_VERSION/program:\$PATH" >> $PROFILE_PATH
echo "export OFFICE_PATH=$RUNTIME_INSTALL_PATH/opt/$INSTALLED_VERSION" >> $PROFILE_PATH
